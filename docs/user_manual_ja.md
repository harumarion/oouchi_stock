# 買い物予報 取扱説明書

買い物予報は、ご家庭の在庫を管理し、買い物予報を提供するアプリです。セール情報と在庫状況から買っておくべき商品を予測します。以下では画面ごとの操作方法をご説明します。
本アプリは Material Design 3 を採用しており、スマートフォンでの利用に最適化された最新のUIを提供します。画面の文字には Google Fonts の **Roboto** を使用しており、可読性を高めています。
カードタイトルや詳細画面では統一されたフォントサイズ(18px)を使用し、補助情報には14pxの文字サイズを適用しています。
アプリアイコンに合わせて淡い青系の配色を採用しており、タブバーも白を基調としたテーマに統一されています。選択中と非選択中で文字色が変わります。
2024年からは画面内で使用するアイコンサイズを従来比1.5倍に拡大しました。より見やすいボタン配置となっています。
## フォントサイズの統一
カードタイトル、カード情報、詳細表示で使用する文字サイズは次のとおりです。

- カードタイトル: **18px**
- カード情報: **16px**
- 詳細表示: **18px**

これらのサイズは `lib/theme.dart` の `AppTheme` クラスで定義されており、画面間で一貫した表示を実現します。
BuyListCard、SaleItemCard、PredictionCard も InventoryCard と同じスタイルを採用し、カード間で統一された読みやすさを確保しています。
また、商品登録・編集フォームやカテゴリの色選択、検索バー、カテゴリ切り替えボタンなどは共通ウィジェットとして切り出されています。どの画面でも同じ操作感で利用できます。
なお、広告表示機能は Android と iOS のみ対応しています。`google_mobile_ads` パッケージのバージョン 4.0.0 以上が必要です。
動作させるには AndroidManifest と iOS の Info.plist にそれぞれ有効な AdMob の App ID を設定する必要があります。テスト用途であればサンプル ID を利用できます。
WebView が無効、またはインストールされていない端末では広告初期化時にエラーログが表示されます。広告機能を利用するには Android System WebView もしくは Chrome を有効にしてください。
また、折りたたみ端末対応のため Jetpack Window Manager ライブラリ 1.0.0 を組み込んでいます。
また、動作させるには AndroidManifest と iOS の Info.plist にそれぞれ有効な AdMob の
App ID を設定しておく必要があります。テスト用途であればサンプル ID を利用できます。
デスクトップ環境などモバイル以外で実行した場合も、テスト ID を利用して広告初期化が行われるため、UnsupportedError は発生しません。
WebView が無効、またはインストールされていない端末では広告の初期化をスキップし、アプリは広告なしで動作します。広告機能を利用するには Android System WebView もしくは Chrome を有効にしてください。
また、AndroidManifest.xml を編集する際は XML 形式を崩さないよう注意し、コメントはタグの外側に記述してください。

## ログイン画面
- 初回起動時にログイン画面が表示されます。設定の読み込みに時間がかかる場合は、読み込み中の画面が表示されます。
- 「匿名で続行」を選ぶと端末のみでデータを管理します。
- Google アカウントでログインすると他の端末とデータを共有できます。
- オフライン状態でログインを試みると「ログインに失敗しました」と表示されます。ネットワーク接続を確認してください。
- ログインできない場合や `CONFIGURATION_NOT_FOUND` エラーが表示される場合は
  Firebase コンソールで匿名認証が有効になっているか確認してください。また、
  端末の Google Play サービスが古い場合や
  インストールされていない場合はログインに失敗することがあります。
  その際は Google Play サービスを更新するか、対応端末でお試しください。
- ログイン画面で使用される Firebase の言語は端末の表示言語に合わせて自動で設定されます。

 -## ホーム画面
  アプリを起動すると買い物リスト画面が表示されます。
- 起動処理中はアプリアイコンを表示したスプラッシュ画面が表示されます。
- オフラインでも起動し、最後に取得したデータを表示します。接続が復旧すると自動的に同期されます。
- オフライン時でも在庫数量の更新が可能で、次回オンライン接続時に履歴を含め同期されます。
- ネットワークの接続状態が変わると、画面下部にオンライン/オフラインのメッセージが表示されます。言語設定が完了してから通知されるため、起動直後は数秒遅れて表示される場合があります。
- 画面下部のメニューバーから各機能に移動できます。左から「買い物リスト」「在庫一覧」「買い物予報」「セール情報」の順に並んでいます。

## 買い物リスト画面
- 下部メニューの「買い物リスト」から移動すると買い物カードのリストが表示されます。
- 買い物カードには、残量が「残り{count}({volume}{unit})」の形式で表示され、残り日数も併記されます。
- 買い物リストには買い物カードを追加することができます。商品名を入力して検索バー右側の「＋」ボタンで買い物カードを追加できます。
- 自動判定で追加された買い物カードが表示されます。
- 買い物カードを選択すると、それに紐づく商品がある場合は商品詳細画面が表示されます。
- 買い物カードを選択して右にスワイプすると削除確認するメッセージが表示されます。購入数を入力しOKボタンで買い物カードが削除され、在庫に購入数が反映されます。スワイプ後はすぐにカードが一覧から消えます。

-## 在庫一覧画面
- 下部メニューの「在庫一覧」から移動すると共通のカテゴリ切り替えボタン(SegmentedButton)でカテゴリを変更できます。選択中のカテゴリの在庫のみが一覧表示されます。
- v1.1 より、カテゴリ変更後に一覧が更新されない不具合を修正しました。
- v1.2 より、カテゴリ削除後に在庫一覧が表示されなくなる問題を解消しました。
- 在庫カードをタップすると商品詳細画面が表示されます。カード右上のメニューボタンから「在庫調整」「使用量入力」「購入量入力」「買い物リストへ追加」を選択できます。カードを右にスワイプすると削除確認ダイアログが表示されます。
- 在庫カードを削除すると、その商品に紐づく履歴やセール情報、買い物リストの項目も同時に削除されます。
 - 数量の変更は履歴として自動記録され、あとから確認できます。
 - 検索バーは画面遷移を伴わない SearchBar となり、虫眼鏡アイコンから直接検索できます。商品名だけでなくカテゴリ名や品種名でも検索できます。
 - 画面を開き直すたびに最新のカテゴリ情報を取得して表示します。
- v1.3 から並び替え機能を廃止し、一覧は常に最終更新順で表示されます。
- v1.4 より検索バーを他画面と同じ部品に差し替えました。
- 品種名や商品名が長い場合は、カード表示後3秒で自動的に横スクロールし、最後まで表示したら元の位置に戻ります。
- 画面右下の「＋」ボタンから商品追加画面を開けます。

## 商品追加画面
- 在庫一覧画面右下の「＋」ボタンから表示されます。
- 商品名、カテゴリ、品種、個数、1個あたり容量、容量単位、メモを入力して保存します。容量単位は1個あたり容量と総容量の表示に使用され、数量には単位が付きません。総容量は入力値から自動計算されます。
- カテゴリが登録されていない場合は「カテゴリが登録されていません」と表示され、カテゴリ追加ボタンが表示されます。
- 品種が登録されていないカテゴリを選ぶと自動的に「その他」が選択されます。
- 品種が登録されているカテゴリを選ぶとリストの先頭の品種が自動的に選択されます。
- 品種リストが未読み込みの状態で画面を開いた場合も、初期値として「その他」が表示されます。
- 個数は画面中央の + / - ボタンで1単位ずつ調整できます。初期値は0で、0個も指定可能です。
- 個数や容量を変更すると総容量が自動で更新されます。総容量は個数と1個あたり容量から算出され、在庫管理にはこの値が使用されます。
- v1.2 より、画面下から表示されていたキーパッドは廃止されました。
- 数値入力欄をタップすると端末標準のキーボードが開き、入力値はすぐに反映されます。
- 容量単位は「個」「本」「袋」「ロール」「リットル」「ミリリットル」「グラム」「キログラム」から選択できます。
- アプリの言語設定が英語の場合は容量単位表記も英語になります。
- 必須項目が未入力の場合はエラーが表示されます。
- ルート画面から開いた場合、保存しても画面遷移せずフォームが初期化されます。
- 画面右上のメニューから設定画面やセール情報管理画面に移動できます。

## 商品詳細画面
- 在庫カードをタップすると遷移します。
- 画面左側に項目名、右側に内容が並ぶ表形式で詳細を確認できます。文字サイズは他の画面より大きめです。
- 履歴は操作日時、操作種別、操作前→操作後の総容量(増減量)の順で表示され、各行は薄いグレーの線で区切られ、カテゴリと同じ文字サイズで表示されます。
- 画面右上の編集アイコンから商品情報を編集できます。
- 月あたりの消費量と残り日数が計算され表示されます。
- 1個あたり容量と総容量が表示されます。
- 上部には商品画像が大きく表示され、画像が無い場合はカテゴリ色のプレースホルダーが表示されます。
- 詳細情報は ListTile で分かれており、視認性が向上しています。
- 履歴は ExpansionTile を使用して折りたたみ表示されます。
- 編集・削除は AppBar のメニューから選択する形式になりました。

## 商品編集画面
- 商品詳細画面の鉛筆アイコンから移動します。
 - 商品名、カテゴリ、品種、1個あたり容量、容量単位、メモを変更して保存します。容量単位は1個あたり容量と総容量の表示に利用され、数量には単位を付けません。
- 容量を変更すると総容量が自動計算されます。
- カテゴリや品種リストはデータベースの更新に合わせて自動で更新されます。
- 品種が未登録のカテゴリを選ぶと、自動的に「その他」が選択されます。
- 品種が登録されているカテゴリを選択すると、リストの先頭の品種が自動で選択されます。
- 編集画面を開いた際に現在の品種がリストに存在しない場合も、先頭の品種に切り替わります。
- 入力内容は ViewModel を通じて即座に反映され、保存後に前の画面へ戻ります。

## セール情報管理画面
- メニューの「セール情報管理」から表示されます。
- カテゴリごとに登録したセール情報をカード形式で一覧表示します。カードは ListTile ベースとなり、タイトルに「品種/商品名」、Trailing 部分に価格と期限がまとめて表示されます。タップすると詳細画面が開きます。
 - 不要になった情報はカードを右にスワイプすると削除確認のポップアップが表示されます。
 - 編集は詳細画面の鉛筆アイコンから行います。
- 各カードには買い物リストに追加するボタンがあります。
- 画面右下の「＋」ボタンでセール情報を追加できます。
- 画面上部には共通のカテゴリ切り替えボタン(SegmentedButton)と検索バーがあり、並び替え用のフィルターチップは画面下部の BottomSheet に配置されています。チップをタップするだけで「あいうえお順」「最終更新順」「単価順」を切り替えられます。
- 期限切れから1日経過した情報は非表示になりますが、画面上の「期限切れも表示」スイッチをオンにすると過去の情報も確認できます。
- 画面右上のメニューから設定画面を開けます。

## セール情報履歴画面
- セール情報管理画面で商品種別をタップすると表示されます。
- 過去の購入履歴が一覧表示され、カードを右にスワイプすると削除確認ダイアログが表示されます。
- 各履歴の詳細は、項目が左、内容が右に並ぶ形式で表示されます。
- 詳細テキストにはテーマの `bodyLarge` スタイル(18px)が使用され、履歴のラベルや値も同じ大きさで統一されています。
- 量や数の単位はアプリの言語設定に合わせて自動で変換されます。

-## セール詳細情報画面
- セール情報管理画面でカードをタップすると表示されます。
- 選択したセール情報のみが項目ごとに表示されます。
- 各項目は ListTile 形式で区切って表示され、読みやすくなりました。
- URL やメモが登録されている場合は下部に表示されます。
## セール情報一覧画面
- 下部メニューの「買い得リスト」から表示されます。
- 各カードには商品名、店舗名、セール価格、通常価格、期間、残り日数、在庫が表示されます。残り在庫が少ない場合はアイコンの色で警告されます。
- 並び替えはヘッダー右上のメニューボタンから選択でき、終了日順・割引率順・単価安い順・おすすめ順に切り替えられます。
- セール通知のオン/オフは通知アイコンのトグルボタンで切り替えます。
- 各カードのボタンから買い物リストに追加できます。
- 期限が近いセールは赤字で表示されます。
 - 上部の検索バーから虫眼鏡アイコンでセール情報を検索できます。予測入力画面へは遷移しません。

## セール情報追加画面
- セール情報管理画面の「＋」ボタンで表示されます。
- 商品、数量、合計容量、通常価格、セール価格、購入店舗、承認ページURL、メモを入力して保存します。確認日は保存時の日時が自動で登録されます。
- 期限の初期値は当日の日付が自動で入力されます。
- 在庫が登録されていない場合は、商品追加ボタンが表示されます。
- 商品名選択は「商品名 / 品種」の順で一覧表示されます。
- 入力した数量と合計容量から単価が自動計算され、画面下部のカードに常に表示されます。
- 期限入力欄をタップするとカレンダー形式のダイアログが開き、日付を選択できます。
- 数量・合計容量・価格は0以上の数値を入力する必要があります。誤った値を入力するとエラーが表示されます。
- 数量や価格の欄をタップすると端末標準のキーボードが表示されます。

-## セール情報編集画面
- セール情報詳細画面右上の鉛筆アイコンをタップすると開きます。
- 追加画面と同じ項目を編集できます。
- 数値入力欄をタップすると端末標準のキーボードが表示され、指で簡単に修正できます。
- 保存後は詳細画面に自動で戻り、変更内容が即座に反映されます。
- セール情報管理画面の一覧カードも自動更新されます。

## 買い物リスト画面
- ホーム画面に表示されるリストです。
- 残量がしきい値以下の商品が一覧表示されます。買うものがなければメッセージが表示されます。
- 画面を開くたびに最新の情報を取得してリストを更新します。
- 画面上部の検索バーから手動で商品名を追加できます。虫眼鏡アイコンは表示されず、検索語を直接入力します。入力時の候補表示はありません。
- 買い物カードには現在の在庫数と予測される残り日数が表示されます。
- 在庫一覧やセール情報、買い物予報画面の各カードに「買い物リストに追加」ボタンがあります。
  追加した商品は元の在庫データへのリンク付きで買い物リストに表示されます。
  在庫一覧から追加した場合も画面を開き直さなくても即座に反映されます。
  各カードには「手動追加」「自動追加」など追加理由も表示されます。
- カードを右にスワイプすると削除できます。削除時に購入数を入力して在庫を増やせます。
- 削除だけした場合でも、在庫を補充するまで同じ商品は自動でリストに復活しません。
- 削除時に入力した数量は在庫一覧にも即座に反映されます。
- カードを長押しすると数量入力ダイアログが開き、在庫に購入数を反映できます。
- 在庫数量を変更してゼロになった場合も、自動的に買い物リストへ追加されます。

## 買い物予報画面
- 上部にはカテゴリ切り替えボタン(SegmentedButton)が配置されています。
- その下の SearchBar から虫眼鏡アイコンで商品を検索できます。検索文字を入力するとその語で絞り込みます。画面遷移は発生しません。

## 自動判定ロジック
- 在庫ゼロなら価格に関係なく買い物リストへ自動追加
- 予測購入日までの残り日数が設定日数以下なら買い物予報リストへ自動追加
- 在庫十分でセール中なら買い物予報リストへ自動追加
- 残り日数が設定日数以下かつセール価格が設定以上の値引きなら買い物リストへ自動追加
自動判定はアプリ起動時に実行され、最新の在庫と価格情報からリストを更新します。

## 設定画面
設定メニューから表示されます。各項目はアイコン付きの ListTile としてカード内に整理され、内容説明がサブテキストに表示されます。
- 「カテゴリ設定」や「品種設定」など各種設定画面へ移動できます。
- 「言語」を選択すると表示言語を英語または日本語に変更でき、Firebase の認証言語も同時に切り替わります。
- 「買い物予報条件設定」「購入判定設定」では自動判定に使用する値を変更できます。
- 広告表示スイッチでバナー広告の有無を切り替えられます。
- 「バックアップ」「復元」は FilledButton で表示され、ボタン下に実行日時がサブテキストとして表示されます。データがない場合は「バックアップデータがありません」と表示されます。
  未実行の場合は「未バックアップ」や「未復元」と表示されます。

### 買い物予報条件設定画面
- **表示タイミング**: 設定画面から「買い物予報条件設定」を選択したときに開きます。
- **表示内容**: 条件種別を選ぶラジオボタン、しきい値と日数の入力欄、保存ボタンが並びます。
- **できること**:
  - しきい値や日数を入力し条件種別を選択
  - 数字キーボードで半角数値のみ入力できます
  - 保存ボタンで設定を保存し前の画面に戻る

### 購入判定設定画面
- **表示タイミング**: 設定画面から「購入判定設定」を選択したときに開きます。
- **表示内容**: 慎重判定日数、買い時判定日数、値引き率の入力欄と保存ボタンを表示します。
- **できること**:
  - 各値を編集して保存
  - 小数点を含む数値も入力できます
  - 保存すると次回以降の自動判定に反映されます。

## カテゴリ設定画面
- **表示タイミング**: 設定画面の「カテゴリ設定」を選択すると表示されます。
- **表示内容**: 登録済みカテゴリの一覧を色付きで表示します。並びはドラッグ操作で変更可能です。
- **できること**:
  - カテゴリをタップして編集画面を開く
  - 右スワイプで削除を実行
  - 右下の「＋」ボタンから名称入力ダイアログを表示して即時追加
  - カラーアイコンをタップしてカラーパレットダイアログから色を変更

## 品種設定画面
- **表示タイミング**: 設定画面の「品種設定」を選択すると表示されます。
- **表示内容**: カテゴリ別のタブに品種名のみを一覧表示します。
- **できること**:
  - 品種をタップして編集
  - 右スワイプで削除
  - 右下の「＋」ボタンで品種を追加
  - 入力内容は即座に反映され、保存後は前の画面へ戻ります。

## アイコンのカスタマイズ
`web/icons` ディレクトリの画像を利用してアプリアイコンを生成できます。
`flutter_launcher_icons` パッケージを導入し、次のコマンドを実行してください。

```bash
flutter pub run flutter_launcher_icons
```

実行後、Android と iOS のアイコンが自動で更新されます。

以上で買い物予報の基本的な操作は完了です。ぜひご活用ください。
